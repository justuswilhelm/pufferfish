#!/usr/bin/env bash
# SPDX-FileCopyrightText: 2014-2025 Justus Perlwitz
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# Back up borgmatic secrets

set -e
# XXX only works on lithium, I guess?
passphrase_path=/var/lib/borgmatic/passphrase
sudo cat "$passphrase_path" | pass insert --multiline fde/lithium/borgbackup/passphrase

for repository in borgbase helium; do
    echo "Exporting keys for repository $repository"
    keys=$(sudo borgmatic key export --verbosity 0 --paper --repository "$repository")
    if [ -n "$keys" ]; then
        export keys
        printenv keys | pass insert --multiline "fde/lithium/borgbackup/$repository"
    else
        echo "Didn't receive keys for repository $repository"
    fi
done
